<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weierstrass ℘ Playground - Interactive Browser Version</title>
    
    <!-- Content Security Policy to allow CDN access -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; 
        font-src 'self' https://cdnjs.cloudflare.com; 
        connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com;
        img-src 'self' data:;
    ">
    
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="desktop-mode" data-theme="dark">
    <div class="container">
        <header class="main-header">
            <h1><i class="fas fa-infinity"></i> Weierstrass ℘ Playground</h1>
            <p class="subtitle">Interactive mathematical playground with dynamic visualizations • Powered by Python-in-browser</p>
        </header>

        <div class="loading-section" id="loading">
            <div class="loader">
                <i class="fas fa-cog fa-spin"></i>
                <p>Loading Pyodide and mathematical libraries...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p class="progress-text" id="progress-text">Initializing...</p>
            </div>
        </div>

        <div class="main-content" id="main-content" style="display: none;">
            <div class="controls-section">
                <div class="control-panel">
                    <div class="control-group">
                        <h3><i class="fas fa-cogs"></i> Visualization Mode</h3>
                        <div class="form-group">
                            <label for="mode">Mode:</label>
                            <select id="mode">
                                <option value="two_panel">Two-panel: ℘(z) and ℘′(z)</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3><i class="fas fa-th"></i> Lattice Parameters</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="p">p:</label>
                                <input type="range" id="p" min="1" max="20" step="0.1" value="11">
                                <span class="value-display" id="p-value">11.0</span>
                            </div>
                            <div class="form-group">
                                <label for="q">q:</label>
                                <input type="range" id="q" min="1" max="20" step="0.1" value="5">
                                <span class="value-display" id="q-value">5.0</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="N">N (truncation):</label>
                            <input type="range" id="N" min="0" max="6" step="1" value="3">
                            <span class="value-display" id="N-value">3</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3><i class="fas fa-paint-brush"></i> Rendering</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="grid-x">Grid X:</label>
                                <input type="range" id="grid-x" min="50" max="200" step="10" value="100">
                                <span class="value-display" id="grid-x-value">100</span>
                            </div>
                            <div class="form-group">
                                <label for="grid-y">Grid Y:</label>
                                <input type="range" id="grid-y" min="50" max="200" step="10" value="100">
                                <span class="value-display" id="grid-y-value">100</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contours">Contours:</label>
                                <input type="range" id="contours" min="0" max="30" step="1" value="10">
                                <span class="value-display" id="contours-value">10</span>
                            </div>
                            <div class="form-group">
                                <label for="vec-density">Vector Density:</label>
                                <input type="range" id="vec-density" min="0" max="30" step="1" value="15">
                                <span class="value-display" id="vec-density-value">15</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="show-vectors" checked>
                                Show vector field arrows
                            </label>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3><i class="fas fa-palette"></i> Color Palette</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="saturation">Saturation:</label>
                                <input type="range" id="saturation" min="0" max="1" step="0.05" value="0.2">
                                <span class="value-display" id="saturation-value">0.20</span>
                            </div>
                            <div class="form-group">
                                <label for="value-floor">Value Floor:</label>
                                <input type="range" id="value-floor" min="0" max="1" step="0.05" value="0.4">
                                <span class="value-display" id="value-floor-value">0.40</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mag-scale">Magnitude Scale:</label>
                            <input type="range" id="mag-scale" min="0.1" max="3" step="0.1" value="0.8">
                            <span class="value-display" id="mag-scale-value">0.8</span>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3><i class="fas fa-atom"></i> Particles & Integration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dt">Time Step (dt):</label>
                                <input type="number" id="dt" min="0.001" max="0.1" step="0.001" value="0.01">
                            </div>
                            <div class="form-group">
                                <label for="T">Duration (T):</label>
                                <input type="range" id="T" min="1" max="30" step="1" value="10">
                                <span class="value-display" id="T-value">10</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="show-lattice" checked>
                                Show lattice trajectories (z=1,2,3..p-1, z'=i)
                            </label>
                        </div>
                        
                        <div class="particles-section">
                            <h4>Initial Conditions</h4>
                            <div id="particles-container">
                                <div class="particle-row">
                                    <input type="text" class="particle-z0" placeholder="z₀ (e.g., 5.5+0j)" value="5.5+0j">
                                    <input type="text" class="particle-v0" placeholder="v₀ (e.g., 0+1j)" value="0+1j">
                                    <button class="remove-particle" onclick="removeParticle(this)">×</button>
                                </div>
                                <div class="particle-row">
                                    <input type="text" class="particle-z0" placeholder="z₀ (e.g., 5+0j)" value="5+0j">
                                    <input type="text" class="particle-v0" placeholder="v₀ (e.g., 0+1j)" value="0+1j">
                                    <button class="remove-particle" onclick="removeParticle(this)">×</button>
                                </div>
                                <div class="particle-row">
                                    <input type="text" class="particle-z0" placeholder="z₀ (e.g., 7+0j)" value="7+0j">
                                    <input type="text" class="particle-v0" placeholder="v₀ (e.g., 0+0j)" value="0+0j">
                                    <button class="remove-particle" onclick="removeParticle(this)">×</button>
                                </div>
                            </div>
                            <button class="add-particle" onclick="addParticle()">+ Add Particle</button>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="action-buttons">
                            <button id="render-btn" class="btn btn-primary">
                                <i class="fas fa-play"></i> Render
                            </button>
                            <button id="save-btn" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Save PNG
                            </button>
                            <button id="help-btn" class="btn btn-info">
                                <i class="fas fa-question-circle"></i> Help
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization-section">
                <div class="computation-status" id="status">
                    <p>Ready to render. Configure parameters and click "Render" to generate visualization.</p>
                </div>
                <div class="plot-container">
                    <div id="plot-area"></div>
                </div>
            </div>
        </div>

        <div class="help-modal" id="help-modal" style="display: none;">
            <div class="modal-content">
                <span class="close-btn" onclick="closeHelp()">&times;</span>
                <h2>Weierstrass ℘ Playground Help</h2>
                
                <h3>About</h3>
                <p>This playground visualizes the Weierstrass ℘ (Weierstrass P) function and integrates particle trajectories following the differential equation:</p>
                <p><code>z''(t) = -℘(z(t)) * z(t)</code></p>
                
                <h3>Parameters</h3>
                <ul>
                    <li><strong>p, q:</strong> Lattice periods defining the rectangular lattice Λ = ℤp + ℤiq</li>
                    <li><strong>N:</strong> Truncation level (higher values = more accurate but slower)</li>
                    <li><strong>Grid X/Y:</strong> Resolution of the field visualization</li>
                    <li><strong>Contours:</strong> Number of topographic contour lines</li>
                    <li><strong>dt:</strong> Integration time step (smaller = more accurate)</li>
                    <li><strong>T:</strong> Total integration time</li>
                </ul>
                
                <h3>Particles</h3>
                <p>Define initial conditions for particle trajectories:</p>
                <ul>
                    <li><strong>z₀:</strong> Initial position (complex number, e.g., 5+2j)</li>
                    <li><strong>v₀:</strong> Initial velocity (complex number, e.g., 0+1j)</li>
                </ul>
                
                <h3>Visualization</h3>
                <p>The left panel shows ℘(z) and the right panel shows ℘'(z). Colors represent the complex field values using HSV mapping.</p>
                <p>Trajectories are overlaid on both panels, with 💥 markers indicating blow-ups near poles.</p>
                
                <h3>Performance</h3>
                <p>For best performance in the browser:</p>
                <ul>
                    <li>Keep grid resolution moderate (50-150)</li>
                    <li>Use N ≤ 4 for real-time interaction</li>
                    <li>Reduce particles for faster computation</li>
                </ul>
            </div>
        </div>

        <footer class="main-footer">
            <p>Powered by <a href="https://pyodide.org/" target="_blank">Pyodide</a> • 
               Running Python + NumPy + Matplotlib entirely in your browser • 
               <a href="https://github.com/litlfred/notebooks" target="_blank">Source Code</a></p>
        </footer>
    </div>

    <!-- Global Control Panel -->
    <div class="global-control-panel" id="global-controls">
        <button class="panel-toggle" onclick="toggleControlPanel()">
            <i class="fas fa-chevron-up" id="panel-toggle-icon"></i>
        </button>
        
        <div class="control-section">
            <h4>Visualizations:</h4>
            <button class="control-btn" id="play-all-btn" onclick="playAllVisualizations()">
                <i class="fas fa-play"></i> Play All
            </button>
            <button class="control-btn" id="pause-all-btn" onclick="pauseAllVisualizations()">
                <i class="fas fa-pause"></i> Pause All
            </button>
            <button class="control-btn danger" id="stop-all-btn" onclick="stopAllVisualizations()">
                <i class="fas fa-stop"></i> Stop All
            </button>
            <button class="control-btn" id="restart-all-btn" onclick="restartAllVisualizations()">
                <i class="fas fa-redo"></i> Restart All
            </button>
        </div>
        
        <div class="control-section">
            <h4>Layout:</h4>
            <button class="control-btn" id="desktop-mode-btn" onclick="setLayoutMode('desktop')">
                <i class="fas fa-desktop"></i> Desktop
            </button>
            <button class="control-btn" id="mobile-mode-btn" onclick="setLayoutMode('mobile')">
                <i class="fas fa-mobile-alt"></i> Mobile
            </button>
        </div>
        
        <div class="control-section">
            <h4>Theme:</h4>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                <i class="fas fa-sun" id="theme-icon"></i>
            </button>
        </div>
        
        <div class="control-section">
            <button class="control-btn success" onclick="saveSession()">
                <i class="fas fa-save"></i> Save Session
            </button>
            <button class="control-btn" onclick="loadSession()">
                <i class="fas fa-folder-open"></i> Load Session
            </button>
        </div>
        
        <div class="session-status">
            <div class="status-dot" id="session-status-dot"></div>
            <span id="session-status-text">Ready</span>
        </div>
    </div>

    <script>
        // Fallback loading for Pyodide with multiple CDN sources
        function loadPyodideScript() {
            const cdnSources = [
                'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js',
                'https://unpkg.com/pyodide@0.24.1/pyodide.js'
            ];
            
            let currentIndex = 0;
            
            function tryLoadScript() {
                if (currentIndex >= cdnSources.length) {
                    console.error('Failed to load Pyodide from all CDN sources');
                    document.getElementById('progress-text').textContent = 'Failed to load Pyodide. Please check your internet connection and refresh the page.';
                    // Load main script even if Pyodide fails so UI functions work
                    loadMainScript();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdnSources[currentIndex];
                script.onload = function() {
                    console.log(`Pyodide loaded successfully from: ${cdnSources[currentIndex]}`);
                    loadMainScript();
                };
                script.onerror = function() {
                    console.warn(`Failed to load Pyodide from: ${cdnSources[currentIndex]}`);
                    currentIndex++;
                    tryLoadScript();
                };
                document.head.appendChild(script);
            }
            
            function loadMainScript() {
                const mainScript = document.createElement('script');
                mainScript.src = 'weierstrass-app.js';
                document.body.appendChild(mainScript);
            }
            
            tryLoadScript();
        }
        
        // Start loading when DOM is ready
        document.addEventListener('DOMContentLoaded', loadPyodideScript);
    </script>
</body>
</html>