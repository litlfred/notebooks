name: Deploy to GitHub Pages

on:
  # Runs on pushes to main branch
  push:
    branches: [ main ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      
  # Runs when PR is approved (for review deployments)
  pull_request_review:
    types: [submitted]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' || (github.event_name == 'pull_request_review' && github.event.review.state == 'approved')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install numpy matplotlib
    
    - name: Test core mathematical functions
      run: |
        cd docs/python
        python -c "
        import weierstrass_core as wc
        import numpy as np
        print('Testing mathematical functions...')
        z = 2.0 + 1.5j
        p, q, N = 11.0, 5.0, 2
        wp_val = wc.wp_rect(z, p, q, N)
        print(f'‚Ñò({z}) = {wp_val}')
        print(f'|‚Ñò({z})| = {abs(wp_val):.4f}')
        assert np.isfinite(wp_val), 'Function returned non-finite value'
        print('‚úì Mathematical functions working correctly')
        "
    
    - name: Validate HTML and JavaScript
      run: |
        # Basic validation that files exist and have expected content
        test -f docs/index.html
        test -f docs/js/weierstrass-app.js
        test -f docs/css/style.css
        test -f docs/python/weierstrass_core.py
        
        # Check that HTML contains expected elements
        grep -q "Weierstrass ‚Ñò Playground" docs/index.html
        grep -q "Pyodide" docs/js/weierstrass-app.js
        
        echo "‚úì Static files validated"
    
    - name: Setup Pages
      uses: actions/configure-pages@v3
      
    - name: Build with Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: ./docs
        destination: ./_site
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: Update deployment status
      run: |
        echo "üöÄ Deployment completed successfully!"
        echo "üì± Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "‚è∞ Deployed at: $(date)"