name: ğŸš€ Deploy Mathematical Notebooks to GitHub Pages

on:
  # Runs on pushes to main branch
  push:
    branches: [ main ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      deploy_branch:
        description: 'ğŸŒ¿ Branch to deploy from (defaults to current branch)'
        required: false
        default: ''
        type: string
      
  # Runs when PR is approved (for review deployments)
  pull_request_review:
    types: [submitted]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'pull_request_review' && github.event.review.state == 'approved')))
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Display deployment info
      run: |
        echo "ğŸš€ Deployment Information"
        echo "========================"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "âš¡ Trigger: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â„¹ï¸  Manual deployment from branch: ${{ github.ref_name }}"
        fi
        echo "========================"
    
    - name: Post deployment start comment
      if: github.event.pull_request.number != null || github.event_name == 'pull_request_review'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request?.number || context.payload.review?.pull_request?.number;
          if (!prNumber) {
            console.log('No PR number found, skipping comment');
            return;
          }
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸš€ **Deployment Status**')
          );
          
          const body = `ğŸš€ **Deployment Status**
          
          â³ **Deployment in progress...**
          
          ğŸ“¦ Repository: \`${{ github.repository }}\`
          ğŸŒ¿ Branch: \`${{ github.ref_name }}\`
          âš¡ Trigger: \`${{ github.event_name }}\`
          ğŸ‘¤ Started by: @${{ github.actor }}
          ğŸ• Started at: ${new Date().toUTCString()}
          
          ---
          *This comment will be updated with deployment results.*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
            core.setOutput('comment_id', botComment.id);
          } else {
            const { data: newComment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
            core.setOutput('comment_id', newComment.id);
          }
          core.setOutput('pr_number', prNumber);
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install numpy matplotlib
    
    - name: Test core mathematical functions
      run: |
        cd src
        python -c "
        import weierstrass_playground.core as wc
        import numpy as np
        print('Testing mathematical functions...')
        z = 2.0 + 1.5j
        p, q, N = 11.0, 5.0, 2
        wp_val = wc.wp_rect(z, p, q, N)
        print(f'â„˜({z}) = {wp_val}')
        print(f'|â„˜({z})| = {abs(wp_val):.4f}')
        assert np.isfinite(wp_val), 'Function returned non-finite value'
        print('âœ“ Mathematical functions working correctly')
        "
    
    - name: Validate markdown and JavaScript
      run: |
        # Basic validation that files exist and have expected content
        test -f docs/index.md
        test -f docs/weierstrass-playground.md
        test -f docs/_layouts/default.html
        test -f docs/weierstrass-playground/weierstrass-app.js
        test -f docs/weierstrass-playground/style.css
        test -d docs/weierstrass-playground/python/weierstrass_playground
        test -f docs/weierstrass-playground/python/weierstrass_playground/__init__.py
        
        # Check that markdown contains expected elements
        grep -q "Weierstrass â„˜ Playground" docs/weierstrass-playground.md
        grep -q "Pyodide" docs/weierstrass-playground/weierstrass-app.js
        
        echo "âœ“ Static files validated"
    
    - name: Setup Pages
      uses: actions/configure-pages@v5
      
    - name: Build with Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: ./docs
        destination: ./_site
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Update deployment status
      run: |
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“± Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "â° Deployed at: $(date)"
    
    - name: Update PR comment with success
      if: always() && (github.event.pull_request.number != null || github.event_name == 'pull_request_review') && needs.build.result == 'success' && steps.deployment.conclusion == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request?.number || context.payload.review?.pull_request?.number;
          if (!prNumber) {
            console.log('No PR number found, skipping comment update');
            return;
          }
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸš€ **Deployment Status**')
          );
          
          const deploymentUrl = '${{ steps.deployment.outputs.page_url }}';
          
          const body = `ğŸš€ **Deployment Status**
          
          âœ… **Deployment Successful!** 
          
          ğŸ“¦ Repository: \`${{ github.repository }}\`
          ğŸŒ¿ Branch: \`${{ github.ref_name }}\`
          âš¡ Trigger: \`${{ github.event_name }}\`
          ğŸ‘¤ Started by: @${{ github.actor }}
          ğŸ• Completed at: ${new Date().toUTCString()}
          
          ## ğŸ‰ Preview your deployment:
          
          <div align="center">
          
          [![ğŸŒ View Live Preview](https://img.shields.io/badge/ğŸŒ_View_Live_Preview-brightgreen?style=for-the-badge&logo=github-pages)](${deploymentUrl})
          
          </div>
          
          ---
          ğŸ“± **Direct URL**: ${deploymentUrl}`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
          }
    
    - name: Update PR comment with failure
      if: always() && (github.event.pull_request.number != null || github.event_name == 'pull_request_review') && (needs.build.result == 'failure' || steps.deployment.conclusion == 'failure')
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request?.number || context.payload.review?.pull_request?.number;
          if (!prNumber) {
            console.log('No PR number found, skipping comment update');
            return;
          }
          
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸš€ **Deployment Status**')
          );
          
          const body = `ğŸš€ **Deployment Status**
          
          âŒ **Deployment Failed**
          
          ğŸ“¦ Repository: \`${{ github.repository }}\`
          ğŸŒ¿ Branch: \`${{ github.ref_name }}\`
          âš¡ Trigger: \`${{ github.event_name }}\`
          ğŸ‘¤ Started by: @${{ github.actor }}
          ğŸ• Failed at: ${new Date().toUTCString()}
          
          ## ğŸ” Check the logs for details:
          
          <div align="center">
          
          [![ğŸ“‹ View Deployment Logs](https://img.shields.io/badge/ğŸ“‹_View_Deployment_Logs-red?style=for-the-badge&logo=github-actions)](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          </div>
          
          ---
          Please check the workflow logs above for error details and try again once issues are resolved.`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
          }